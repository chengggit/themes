name: Create Theme Discussion

on:
  push:
    branches:
      - master
    paths:
      - 'index.json'

jobs:
  create-discussion:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      discussions: write

    steps:
      - name: Checkout current
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get new themes
        id: new-themes
        run: |
          git show HEAD~1:index.json > old_index.json 2>/dev/null || echo '{"themes":[]}' > old_index.json
          jq -r '.themes[].repo' old_index.json | sort > old_themes.txt
          jq -r '.themes[].repo' index.json | sort > new_themes.txt
          NEW_THEMES=$(comm -13 old_themes.txt new_themes.txt | tr '\n' ' ')
          echo "themes=$NEW_THEMES" >> $GITHUB_OUTPUT

      - name: Create discussions for new themes
        if: steps.new-themes.outputs.themes != ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x .github/scripts/create-discussion.sh
          .github/scripts/create-discussion.sh "${{ steps.new-themes.outputs.themes }}" "${{ github.repository_id }}" "${{ vars.DISCUSSION_CATEGORY_ID }}"
